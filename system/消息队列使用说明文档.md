# 消息队列使用说明文档

## 概述

基于 MySQL 存储的轻量级消息队列系统，支持多虚拟主机、多队列、多消费者的分布式消息处理。

### 功能特性

- 多虚拟主机：不同虚拟主机连接不同数据库，实现业务隔离
- 多队列管理：支持配置多个队列，每个队列独立消费
- 多消费者进程：每个队列可配置多个消费者并行处理
- 消息锁机制：确保同一消息同一时间只被一个消费者处理
- 失败重试：指数退避重试，消息永不丢失
- 配置热加载：修改队列配置后自动生效
- 多环境支持：支持 local/dev/test/pro 环境配置
- Web 管理界面：可视化管理和监控

---

## 快速开始

### 1. 创建数据库表

在需要使用消息队列的数据库中创建 `mq` 表：

```sql
CREATE TABLE `mq` (
  `unqid` char(35) NOT NULL COMMENT '消息唯一ID',
  `vHost` char(50) NOT NULL COMMENT '虚拟主机',
  `group` char(50) NOT NULL COMMENT '队列组',
  `name` char(50) NOT NULL COMMENT '队列名称',
  `msgId` char(110) NOT NULL COMMENT '消息ID',
  `data` longtext NOT NULL COMMENT '消息数据(JSON)',
  `syncCount` int(11) NOT NULL COMMENT '重试次数',
  `updateTime` timestamp NOT NULL DEFAULT '2000-01-01 00:00:00' COMMENT '更新时间',
  `createTime` timestamp NOT NULL DEFAULT '2000-01-01 00:00:00' COMMENT '创建时间',
  `syncLevel` int(11) NOT NULL COMMENT '重试等级',
  `lockTime` timestamp NOT NULL DEFAULT '2000-01-01 00:00:00' COMMENT '锁定/下次执行时间',
  `lockMark` char(32) NOT NULL COMMENT '锁定标识',
  PRIMARY KEY (`name`,`unqid`) USING BTREE,
  KEY `idx_msgId` (`msgId`) USING BTREE,
  KEY `idx_consumer` (`lockTime`,`name`,`group`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='消息队列表';
```

### 2. 配置数据库连接

编辑 `system/config/db.php`（或对应环境的配置文件）：

```php
<?php
return [
    'default' => [
        'host'     => '127.0.0.1',
        'port'     => 3306,
        'user'     => 'root',
        'password' => 'password',
        'database' => 'mydb',
        'charset'  => 'utf8mb4'
    ],
];
```

### 3. 配置队列

编辑 `system/config/mq.php`：

```php
<?php
return [
    'default' => [
        'testMq1' => [
            'cNum' => 2,  // 消费者进程数
            'call' => 'app\system\TestController::testMq1'  // 回调方法
        ],
    ],
];
```

### 4. 编写回调方法

```php
<?php
namespace app\system;

class TestController
{
    public static function testMq1($message)
    {
        // 处理消息
        $data = $message['data'];
        
        // 返回 true 表示成功，消息将被删除
        return true;
    }
}
```

### 5. 启动消费者

```bash
# 后台启动
php index.php system/mq/daemon

# 或访问 Web 管理页面启动
# http://your-domain/system/mq/index
```

### 6. 发送消息

```php
use app\system\MqManager;

MqManager::set('testMq1', ['userId' => 123, 'action' => 'register']);
```

---

## 配置说明

### 数据库配置

文件位置：`system/config/db.php`（按环境加载对应文件）

| 环境 | ENV值 | 配置文件 |
|------|-------|---------|
| 本地 | local | db-local.php |
| 开发 | dev | db-dev.php |
| 测试 | test | db-test.php |
| 生产 | pro | db.php（默认） |

在入口文件设置环境：
```php
defined('ENV') || define('ENV', 'dev');
```

配置格式：
```php
<?php
return [
    // 虚拟主机名 => 连接配置
    'default' => [
        'host'     => '127.0.0.1',
        'port'     => 3306,
        'user'     => 'root',
        'password' => 'password',
        'database' => 'mydb',
        'charset'  => 'utf8mb4'
    ],
    'other_vhost' => [
        // 另一个数据库连接...
    ],
];
```

### 队列配置

文件位置：`system/config/mq.php`

```php
<?php
return [
    // 虚拟主机名
    'default' => [
        // 队列名 => 配置
        'emailQueue' => [
            'cNum' => 3,  // 消费者进程数量
            'call' => 'app\service\EmailService::send',  // 回调方法
        ],
        'orderQueue' => [
            'cNum' => 5,
            'call' => 'app\service\OrderService::process',
        ],
    ],
    // 另一个虚拟主机
    'iscs' => [
        'syncQueue' => [
            'cNum' => 2,
            'call' => 'app\service\SyncService::handle',
        ],
    ],
];
```

---

## 发送消息

### 基本发送

```php
use app\system\MqManager;

// 发送到默认虚拟主机的队列
MqManager::set('queueName', [
    'userId' => 123,
    'action' => 'create'
]);

// 发送到指定虚拟主机
MqManager::set('queueName', $data, 'iscs');

// 指定虚拟主机和队列组
MqManager::set('queueName', $data, 'default', 'myGroup');
```

### 批量发送

```php
$dataList = [
    ['id' => 1, 'name' => '张三'],
    ['id' => 2, 'name' => '李四'],
];

$msgIds = MqManager::setBatch('queueName', $dataList);
$msgIds = MqManager::setBatch('queueName', $dataList, 'iscs');
```

---

## 消费者回调

### 返回值说明

| 返回值 | 说明 |
|-------|------|
| `true` | 处理成功，消息被删除 |
| `false` | 处理失败，按指数退避重试 |
| 正整数 | 处理失败，指定秒数后重试 |

### 示例

```php
public static function myCallback($message)
{
    // $message 结构
    // [
    //     'id' => '消息ID',
    //     'data' => [...],      // 发送时的数据
    //     'time' => 1234567890  // 发送时间戳
    // ]
    
    try {
        $data = $message['data'];
        
        // 处理业务逻辑...
        
        return true;  // 成功
        
    } catch (\Exception $e) {
        error_log($e->getMessage());
        return false;  // 失败，进入重试
    }
}

// 自定义重试延迟
public static function customRetry($message)
{
    $result = doSomething($message);
    
    if ($result === 'success') {
        return true;
    }
    
    // 1小时后重试
    return 3600;
}
```

---

## 重试机制

### 默认策略（指数退避）

当回调返回 `false` 时，按 2^n 分钟延迟重试：

| 重试次数 | 延迟时间 |
|---------|---------|
| 第1次 | 2分钟 |
| 第2次 | 4分钟 |
| 第3次 | 8分钟 |
| 第4次 | 16分钟 |
| 第5次 | 32分钟 |
| ... | ... |

### 特点

- **消息永不自动删除**：只有回调返回 `true` 才会删除
- **消息锁机制**：同一消息同一时间只被一个消费者处理
- **进程崩溃保护**：锁定超时（5分钟）后消息会被其他消费者重新获取
- **手动重置**：可在管理页面点击"重置"按钮，将重试次数清零立即重试

---

## CLI 命令

```bash
# 后台启动（生产环境）
php index.php system/mq/daemon

# 前台启动（调试用，可看到日志输出）
php index.php system/mq/start

# 停止
php index.php system/mq/stop

# 重启
php index.php system/mq/restart

# 查看状态
php index.php system/mq/status
```

---

## Web 管理界面

### 队列管理页面

地址：`/system/mq/index`

功能：
- 查看主进程和消费者运行状态
- 启动/停止/重启主进程
- 查看各队列待处理消息数量
- 发送测试消息

### 消息列表页面

地址：`/system/mq/list`

功能：
- 按条件筛选消息（虚拟主机、队列名称、消息ID、消息内容、状态等）
- 查看消息详情
- 手动执行消息
- 重置失败消息（清零重试次数）
- 删除消息

---

## API 接口

### 获取状态数据
```
GET /system/mq/statusData
```

### 获取消息列表
```
GET /system/mq/messages?vhost=default&name=queueName&data=keyword&page=1&pageSize=20
```

参数：
- `vhost` - 虚拟主机
- `name` - 队列名称（模糊搜索）
- `group` - 队列组
- `msgId` - 消息ID（模糊搜索）
- `data` - 消息内容（模糊搜索）
- `locked` - 锁定状态（0/1）
- `syncLevel` - 重试等级
- `page` - 页码
- `pageSize` - 每页数量

### 获取消息详情
```
GET /system/mq/detail?vhost=default&name=queueName&unqid=xxx
```

### 执行消息
```
POST /system/mq/execute
Body: vhost=default&name=queueName&unqid=xxx
```

### 重置消息
```
POST /system/mq/reset
Body: vhost=default&name=queueName&unqid=xxx
```

### 删除消息
```
POST /system/mq/delete
Body: vhost=default&name=queueName&unqid=xxx
```

### 发送测试消息
```
GET /system/mq/test?vhost=default&queue=queueName&count=10
```

---

## 文件结构

```
system/
├── config/
│   ├── db.php           # 数据库配置（生产环境）
│   ├── db-dev.php       # 数据库配置（开发环境）
│   └── mq.php           # 队列配置
├── data/
│   └── mq/
│       ├── lock/        # 进程锁文件
│       └── log/         # 消费者日志
├── DbManager.php        # 数据库连接管理器
├── MqController.php     # 控制器（Web界面、CLI命令）
├── MqManager.php        # 队列管理器（核心类）
├── asyncProc.vbs        # Windows异步进程启动脚本
└── 消息队列使用说明文档.md
```

---

## 最佳实践

### 1. 保证幂等性

```php
public static function handleOrder($message)
{
    $orderId = $message['data']['orderId'];
    
    // 先检查是否已处理
    if (Order::isProcessed($orderId)) {
        return true;
    }
    
    // 处理订单...
    return true;
}
```

### 2. 异常处理

```php
public static function safeCallback($message)
{
    try {
        // 业务逻辑
        return true;
    } catch (\Exception $e) {
        Log::error('MQ处理失败', [
            'message' => $message,
            'error' => $e->getMessage()
        ]);
        return false;
    }
}
```

### 3. 生产环境部署（Supervisor）

```ini
[program:mq-daemon]
command=php /path/to/index.php system/mq/daemon
autostart=true
autorestart=true
user=www-data
stdout_logfile=/var/log/mq-daemon.log
```

---

## 常见问题

### Q: 消息一直在重试？

检查回调方法是否正确返回 `true`。只有返回 `true` 才会删除消息。

可在消息列表页面点击"重置"按钮清零重试次数立即重试。

### Q: 修改代码后需要重启吗？

| 修改内容 | 是否需要重启 |
|---------|-------------|
| config/mq.php | 否（自动热加载） |
| config/db.php | 否（自动热加载） |
| 回调方法代码 | **是** |
| MqManager/MqController | **是** |

重启命令：`php index.php system/mq/restart`

### Q: 如何停止某个队列？

将 `config/mq.php` 中该队列的 `cNum` 设为 0，或删除该队列配置。

### Q: 如何查看日志？

日志位于 `system/data/mq/log/` 目录，按队列名称命名。

### Q: Windows 支持吗？

支持，但建议在 Linux 环境使用以获得更好的进程管理能力。
